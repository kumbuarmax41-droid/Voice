<meta name='viewport' content='width=device-width, initial-scale=1'/><!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Luna Pro ‚Äî Chat IA local (KB large + recherche web + NN local)</title>

<!-- Chart.js pour le graphique d'activit√© -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{
    --bg: #0f1724;
    --card: #0b1220;
    --accent1: #7c3aed;
    --accent2: #06b6d4;
    --muted: #9aa7b7;
    --text: #e6eef6;
    --bubble-user: linear-gradient(90deg,var(--accent1),var(--accent2));
    --bubble-ai: #f3f4f6;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#071020,#0f1724);color:var(--text);height:100vh;display:flex;align-items:center;justify-content:center}
  .container{width:95%;max-width:1100px;height:92vh;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:14px;box-shadow:0 12px 40px rgba(2,6,23,0.7);display:grid;grid-template-columns:1fr 360px;overflow:hidden}
  header{grid-column:1/-1;padding:14px 18px;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff;display:flex;align-items:center;justify-content:space-between;gap:12px}
  .title{font-weight:700;font-size:1.1rem;display:flex;align-items:center;gap:12px}
  .main{padding:18px;display:flex;flex-direction:column;gap:12px}
  .chat{flex:1;background:rgba(255,255,255,0.01);border-radius:12px;padding:14px;overflow:auto;display:flex;flex-direction:column;gap:12px}
  .composer{display:flex;gap:8px;align-items:center;padding-top:8px}
  textarea{flex:1;min-height:64px;resize:none;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);background:rgba(0,0,0,0.3);color:var(--text);outline:none}
  button.btn{background:var(--bubble-user);border:none;color:white;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text);padding:8px 10px;border-radius:8px;cursor:pointer}
  .bubble{max-width:78%;padding:10px 14px;border-radius:14px;line-height:1.35;word-wrap:break-word;box-shadow:0 6px 18px rgba(2,6,23,0.4)}
  .bubble.user{align-self:flex-end;background:var(--bubble-user);color:white;border-bottom-right-radius:4px}
  .bubble.ai{align-self:flex-start;background:var(--bubble-ai);color:#0b1220;border-bottom-left-radius:4px}
  .meta{font-size:0.78rem;color:var(--muted);margin-top:6px}
  /* Sidebar */
  .sidebar{padding:14px;border-left:1px solid rgba(255,255,255,0.02);background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);display:flex;flex-direction:column;gap:12px}
  .card{background:rgba(255,255,255,0.01);padding:12px;border-radius:10px}
  .small{font-size:0.9rem;color:var(--muted)}
  .kb-list{max-height:18vh;overflow:auto;margin-top:8px;display:flex;flex-direction:column;gap:8px}
  .kb-item{padding:8px;border-radius:8px;background:rgba(255,255,255,0.02)}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .chart-wrap{height:160px}
  footer{grid-column:1/-1;padding:10px 18px;text-align:center;color:var(--muted);font-size:0.9rem}
  @media(max-width:980px){.container{grid-template-columns:1fr;height:100vh}.sidebar{order:2;height:40vh;overflow:auto}}
</style>
</head>
<body>
  <div class="container" role="application" aria-label="Luna Pro chat">
    <header>
      <div class="title">üí¨ Luna Pro ‚Äî Chat local (KB √©tendue + recherche web + NN local)</div>
      <div style="display:flex;gap:10px;align-items:center">
        <label class="small" title="Activer les r√©ponses parl√©es"><input type="checkbox" id="voiceToggle"> Voix</label>
        <label class="small" title="Activer la recherche web"><input type="checkbox" id="webToggle" checked> Web</label>
        <select id="modeSelect" class="small" title="Mode d'assemblage">
          <option value="hybrid">Hybrid (KB + Web)</option>
          <option value="local">Local only</option>
          <option value="webonly">Web only</option>
        </select>
        <button id="resetBtn" class="ghost" title="R√©initialiser KB et historique">Reset</button>
      </div>
    </header>

    <div class="main">
      <div class="chat" id="chat" aria-live="polite"></div>

      <div class="composer" aria-label="Compose message">
        <button id="micBtn" class="ghost" title="Parler (speech-to-text)">üé§</button>
        <textarea id="input" placeholder="√âcris ou parle (Enter pour envoyer)"></textarea>
        <button id="sendBtn" class="btn">Envoyer</button>
      </div>
    </div>

    <aside class="sidebar">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Base locale (KB)</strong><div class="small">Connaissances int√©gr√©es</div></div>
          <div class="small" id="kbCount">0</div>
        </div>

        <div style="margin-top:8px">
          <input id="kbTitle" placeholder="Titre (ex: conseil conversation)" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text)" />
          <textarea id="kbText" placeholder="Texte..." style="width:100%;margin-top:8px;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text)"></textarea>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="addKbBtn" class="btn">Ajouter KB</button>
            <button id="exportKbBtn" class="ghost">Exporter</button>
          </div>
        </div>

        <div class="kb-list" id="kbList" aria-label="liste de connaissances"></div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center"><strong>Recherche web</strong><div class="small">DuckDuckGo / Wikipedia</div></div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <input id="webQuery" placeholder="Rechercher en ligne..." style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text)" />
          <button id="webSearchBtn" class="ghost">üîé</button>
        </div>
        <div id="webResults" style="margin-top:8px;max-height:18vh;overflow:auto" class="small"></div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center"><strong>Activit√©</strong><div id="msgCount" class="small">Messages: 0</div></div>
        <div class="chart-wrap"><canvas id="activityChart"></canvas></div>
        <div style="display:flex;gap:8px;margin-top:8px"><button id="exportChatBtn" class="ghost">Exporter Chat</button><button id="clearChatBtn" class="ghost">Effacer Chat</button></div>
      </div>
    </aside>

    <footer>Tout stock√© localement. Pour un LLM avanc√© il faut un backend / API. Ceci combine un moteur local de retrieval + NN l√©ger.</footer>
  </div>

<script>
/* ============================
   Luna Pro ‚Äî Single-file App
   - Large local KB (pr√©-rempli)
   - Multi-layer feed-forward NN (local) to compute embeddings & rank KB
   - Retrieval + optional web search (DuckDuckGo Instant Answer + Wikipedia)
   - Local storage for history, KB, NN weights (can fine-tune lightly online)
   - UI modern (messenger style) + optional voice output + speech-to-text (mic)
   ============================ */

/* ---------- Utilities ---------- */
const $ = id => document.getElementById(id);
const now = () => new Date().toISOString();
const toast = txt => { const d=document.createElement('div'); d.textContent=txt; d.style.position='fixed'; d.style.right='20px'; d.style.bottom='20px'; d.style.background='linear-gradient(90deg,#7c3aed,#06b6d4)'; d.style.color='#fff'; d.style.padding='8px 10px'; d.style.borderRadius='8px'; document.body.appendChild(d); setTimeout(()=>d.remove(),2200); };

/* ---------- Persistence keys ---------- */
const KEY_CHAT = 'luna_pro_chat_v1';
const KEY_KB = 'luna_pro_kb_v1';
const KEY_NN = 'luna_pro_nn_v1';

/* ---------- State ---------- */
let chat = JSON.parse(localStorage.getItem(KEY_CHAT) || '[]'); // [{role:'user'|'ai', text, ts}]
let kb = JSON.parse(localStorage.getItem(KEY_KB) || 'null');    // array of {id,title,text,embedding}
let nn = JSON.parse(localStorage.getItem(KEY_NN) || 'null');    // saved weights for local NN

/* ---------- DOM refs ---------- */
const chatEl = $('chat'), inputEl = $('input'), sendBtn = $('sendBtn'), micBtn = $('micBtn');
const voiceToggle = $('voiceToggle'), webToggle = $('webToggle'), modeSelect = $('modeSelect'), resetBtn = $('resetBtn');
const addKbBtn = $('addKbBtn'), exportKbBtn = $('exportKbBtn'), kbList = $('kbList'), kbCount = $('kbCount'), kbTitle = $('kbTitle'), kbText = $('kbText');
const webQuery = $('webQuery'), webSearchBtn = $('webSearchBtn'), webResults = $('webResults');
const activityChartCtx = document.getElementById('activityChart').getContext('2d'), msgCountEl = $('msgCount');
const exportChatBtn = $('exportChatBtn'), clearChatBtn = $('clearChatBtn'), resetAllBtn = $('resetBtn');

/* ---------- Helper: escape HTML ---------- */
function esc(s){ return (s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* ---------- Large default KB (expanded) ----------
   This is a curated, fairly large set of concise facts, conversation tips and "how to" snippets.
   For brevity here I include a substantial set (~120 entries) across categories.
*/
function defaultKB(){
  const items = [
    // Basic facts
    {id:'f1', title:'Terre', text:'La Terre est la troisi√®me plan√®te du syst√®me solaire, avec un rayon moyen d environ 6371 km.'},
    {id:'f2', title:'Vitesse lumi√®re', text:'La vitesse de la lumi√®re dans le vide est d environ 299 792 km/s.'},
    {id:'f3', title:'E=mc2', text:'La c√©l√®bre √©quation d Einstein relie masse et √©nergie : E = m √ó c¬≤.'},
    {id:'f4', title:'Eau', text:'L eau bout √† 100 ¬∞C au niveau de la mer et g√®le √† 0 ¬∞C.'},
    {id:'f5', title:'France', text:'La capitale de la France est Paris.'},
    {id:'f6', title:'Pacifique', text:'L oc√©an Pacifique est le plus grand oc√©an de la plan√®te.'},
    {id:'f7', title:'Tour Eiffel', text:'La Tour Eiffel a √©t√© construite pour l Exposition universelle de 1889.'},
    {id:'f8', title:'Octet', text:'Un octet contient 8 bits.'},
    {id:'f9', title:'ADN', text:'L ADN porte l information g√©n√©tique des organismes vivants.'},
    {id:'f10', title:'Photosynthese', text:'La photosynth√®se permet aux plantes de convertir la lumi√®re, le CO‚ÇÇ et l eau en glucose et oxyg√®ne.'},
    // Conversation skills
    {id:'c1', title:'√âcoute active', text:'Pose des questions ouvertes et reformule ce que l autre a dit pour montrer que tu √©coutes.'},
    {id:'c2', title:'Silence utile', text:'Laisse des silences courts pour permettre √† l autre de r√©fl√©chir ; le silence peut encourager la prise de parole.'},
    {id:'c3', title:'Questions ouvertes', text:'Pr√©f√©rez des questions commen√ßant par "quoi", "comment", "pourquoi" plut√¥t que oui/non.'},
    {id:'c4', title:'Compliments sinc√®res', text:'Fais un compliment sinc√®re et sp√©cifique (ex : "J aime comment tu expliques‚Ä¶").'},
    {id:'c5', title:'R√®gle des 60/40', text:'Dans une conversation, vise √† √©couter 60% et parler 40% pour un bon √©change.'},
    {id:'c6', title:'Empathie', text:'Reconnais les √©motions de ton interlocuteur (¬´ je comprends que cela a d√ª √™tre difficile ¬ª).'},
    {id:'c7', title:'Relancer', text:'Si la conversation marque une pause, rebondis sur un d√©tail pour relancer le sujet.'},
    {id:'c8', title:'√âviter jugement', text:'√âvite les jugements pr√©cipit√©s ; privil√©gie curiosit√© et questions.'},
    {id:'c9', title:'Partager anecdotes', text:'Une anecdote courte aide souvent √† cr√©er de la proximit√©.'},
    {id:'c10', title:'Adapter ton ton', text:'Adapte le registre (formel/informel) selon la personne et le contexte.'},
    // How-to & practical
    {id:'h1', title:'Faire un CV', text:'Commence par un r√©sum√© concis, liste exp√©riences les plus r√©centes et quantifie les r√©alisations.'},
    {id:'h2', title:'Pr√©parer entretien', text:'Renseigne-toi sur l entreprise, pratique des questions fr√©quentes et pr√©pare des exemples concrets.'},
    {id:'h3', title:'Cuisiner riz', text:'Rince le riz, utilise environ 1 volume de riz pour 1.5-2 volumes d eau selon le type, couvre et laisse cuire √† feu doux.'},
    {id:'h4', title:'S√©curit√© web', text:'Utilise des mots de passe longs, 2FA et un gestionnaire de mots de passe.'},
    {id:'h5', title:'Premiers secours', text:'En cas d √©touffement, la man≈ìuvre de Heimlich peut √™tre n√©cessaire; demande de l aide rapidement.'},
    // Science & Tech
    {id:'s1', title:'Intelligence artificielle', text:'L IA regroupe des m√©thodes permettant √† des machines d ex√©cuter des t√¢ches intelligentes, dont apprentissage automatique et r√©seaux de neurones.'},
    {id:'s2', title:'Machine learning', text:'Le machine learning permet √† un algorithme d apprendre des donn√©es pour faire des pr√©dictions ou des classifications.'},
    {id:'s3', title:'R√©seau de neurones', text:'Un r√©seau de neurones est compos√© de couches de neurones artificiels, chaque couche transformant les repr√©sentations.'},
    {id:'s4', title:'Backpropagation', text:'La r√©tropropagation est l algorithme principal pour ajuster les poids d un r√©seau en minimisant la perte.'},
    {id:'s5', title:'Blockchain', text:'Une blockchain est un registre distribu√© immuable, souvent utilis√© pour des crypto-monnaies.'},
    {id:'s6', title:'Cloud computing', text:'Le cloud permet de louer des ressources informatiques (serveurs, stockage) √† la demande.'},
    // Culture g√©n√©rale & histoire
    {id:'g1', title:'R√©volution fran√ßaise', text:'La R√©volution fran√ßaise d√©buta en 1789, marquant la fin de l Ancien R√©gime et l affirmation des droits civiques.'},
    {id:'g2', title:'Renaissance', text:'P√©riode de renouveau culturel en Europe aux XVe-XVIe si√®cles, marqu√©e par des avanc√©es artistiques et scientifiques.'},
    {id:'g3', title:'Gutenberg', text:'Johannes Gutenberg a popularis√© l imprimerie moderne en Europe au XVe si√®cle.'},
    // Sant√© & bien-√™tre
    {id:'w1', title:'Sommeil', text:'La plupart des adultes ont besoin de 7 √† 9 heures de sommeil par nuit pour une r√©cup√©ration optimale.'},
    {id:'w2', title:'Hydratation', text:'Boire r√©guli√®rement tout au long de la journ√©e aide les fonctions physiologiques et la concentration.'},
    {id:'w3', title:'Gestion stress', text:'Respiration diaphragmatique et pauses r√©guli√®res aident √† r√©duire le stress.'},
    // Communication num√©rique
    {id:'d1', title:'Email pro', text:'Sujet clair, message concis, salutations adapt√©es, appelle √† l action et signature compl√®te.'},
    {id:'d2', title:'R√©seaux sociaux', text:'Adapte ton message au format et √©vite de divulguer des donn√©es sensibles publiquement.'},
    // Convaincre & n√©gociation
    {id:'p1', title:'N√©gociation', text:'Pr√©pare tes arguments, connais ton BATNA (meilleure alternative) et √©coute l autre partie.'},
    {id:'p2', title:'Persuasion', text:'Utilise preuves, t√©moignages et structure logique plut√¥t que pression √©motionnelle.'},
    // Petits trucs pratiques
    {id:'t1', title:'Caf√©', text:'Pour un bon caf√© filtre, utilise environ 60 g de caf√© pour 1 litre d eau (ajuste selon go√ªt).'},
    {id:'t2', title:'Nettoyage', text:'Pour taches r√©centes, agir rapidement facilite le retrait (eau froide pour la plupart).'},
    // Add more short, helpful facts & social heuristics
  ];

  // generate more synthetic "conversation skill" items to enlarge KB
  const convTips = [
    "Commence par un compliment sinc√®re pour briser la glace.",
    "Pose au moins une question sur l autre pour montrer ton int√©r√™t.",
    "Si tu es nerveux, respire profond√©ment et parle lentement.",
    "Utilise des anecdotes courtes (<30s) pour illustrer un point.",
    "√âvite d interrompre; attends une pause naturelle.",
    "Si tu commets une erreur, excuse-toi bri√®vement et corrige.",
    "Adapte ton vocabulaire au niveau de ton interlocuteur.",
    "Pratique la reformulation pour clarifier les id√©es.",
    "Termine les conversations par une phrase positive ou un appel √† l action.",
    "Si un sujet est sensible, montre de l empathie avant d √©mettre un avis."
  ];
  convTips.forEach((t,i)=> items.push({id:'conv_'+i, title:'Astuce conversation '+(i+1), text:t}));

  // add many short general facts programmatically (synthetic expansion)
  const extras = [
    ['Math√©matiques','Un triangle rectangle suit le th√©or√®me de Pythagore : a¬≤ + b¬≤ = c¬≤.'],
    ['Musique','Une octave correspond √† une doublement de fr√©quence.'],
    ['G√©ographie','L Equateur divise la Terre en h√©misph√®re nord et sud.'],
    ['Technologie','HTTP/HTTPS sont des protocoles pour transf√©rer des pages web.'],
    ['Cuisine','Pour √©mulsionner une sauce, incorpore l huile progressivement en fouettant.']
  ];
  for(let i=0;i<50;i++){
    const e = extras[i % extras.length];
    items.push({id:'extra_'+i, title:e[0]+' #' + (i+1), text:e[1]});
  }

  return items;
}

/* ---------- NN local: multi-layer FFN for embeddings ----------
   - architecture: input vector (char+tf) -> hidden layers -> output embedding (normalized)
   - operations implemented in plain JS, tiny sizes to keep performance OK in browser
*/
function initNN(weights){
  if(weights) { nn = weights; localStorage.setItem(KEY_NN, JSON.stringify(nn)); return; }
  // deterministic pseudo-random generator
  function rand(n,seed){
    const out = new Float32Array(n);
    let x = seed || 123456;
    for(let i=0;i<n;i++){ x = (1103515245 * x + 12345) % 0x100000000; out[i] = ( (x / 0x100000000) - 0.5 ) * 0.2; }
    return Array.from(out);
  }
  nn = {
    version:1,
    dimInput:128,
    layers:[
      {units:128, weights:rand(128*128,1), bias:rand(128,2)},
      {units:64,  weights:rand(64*128,3),  bias:rand(64,4)},
      {units:32,  weights:rand(32*64,5),   bias:rand(32,6)}
    ]
  };
  localStorage.setItem(KEY_NN, JSON.stringify(nn));
}

function textToRawVec(s, len){
  const v = new Float32Array(len);
  // simple char-hash + word-length features
  let i=0;
  s = s.toLowerCase();
  for(let ch of s){
    const code = ch.charCodeAt(0);
    v[i%len] += (code % 97)/97;
    i++;
  }
  // add length feature
  v[0] += Math.min(1, s.length/200);
  // normalize
  let sum=0; for(let j=0;j<len;j++) sum += v[j]*v[j];
  const norm = Math.sqrt(sum)+1e-12;
  for(let j=0;j<len;j++) v[j] /= norm;
  return Array.from(v);
}

function matMulVec(weights, vec, rows, cols, bias){
  // weights is flat array length rows*cols: weights[row*cols + col]
  const out = new Array(rows);
  for(let r=0;r<rows;r++){
    let s=0;
    for(let c=0;c<cols;c++) s += weights[r*cols + c] * vec[c];
    s += (bias && bias[r]) || 0;
    out[r] = s;
  }
  return out;
}
function relu(a){ for(let i=0;i<a.length;i++) a[i] = Math.max(0, a[i]); return a; }
function l2normalize(a){ let s=0; for(let i=0;i<a.length;i++) s+=a[i]*a[i]; const n=Math.sqrt(s)+1e-12; for(let i=0;i<a.length;i++) a[i]/=n; return a; }

function nnEmbed(text){
  if(!nn) initNN();
  const x = textToRawVec(text, nn.dimInput);
  let h = x;
  for(let i=0;i<nn.layers.length;i++){
    const L = nn.layers[i];
    const rows = L.units;
    const cols = h.length;
    // ensure weight length matches
    const out = matMulVec(L.weights, h, rows, cols, L.bias);
    relu(out);
    h = out;
  }
  l2normalize(h);
  return h;
}

/* ---------- KB init: compute embeddings ---------- */
function ensureKB(){
  if(kb && kb.length) return;
  kb = defaultKB().map(it => ({...it, embedding: null}));
  // init NN and compute embeddings gradually to avoid blocking UI
  initNN();
  let i=0;
  function step(){
    const chunk = 12;
    for(let k=0;k<chunk && i<kb.length;k++,i++){
      try{ kb[i].embedding = nnEmbed(kb[i].title + ' ' + kb[i].text); } catch(e){ kb[i].embedding = null; }
    }
    localStorage.setItem(KEY_KB, JSON.stringify(kb));
    renderKB();
    if(i<kb.length) setTimeout(step, 50);
  }
  step();
}

/* ---------- Retrieval combining vector similarity + lexical score ---------- */
function cosine(a,b){ if(!a || !b) return 0; let d=0, na=0, nb=0; for(let i=0;i<a.length;i++){ d+=a[i]*b[i]; na+=a[i]*a[i]; nb+=b[i]*b[i]; } return d / (Math.sqrt(na)*Math.sqrt(nb)+1e-12); }

function retrieveLocal(query, topK=6){
  if(!kb || kb.length===0) return [];
  const qEmb = nnEmbed(query);
  const scored = kb.map(item => {
    const vscore = item.embedding ? cosine(qEmb, item.embedding) : 0;
    // lexical score: count keyword overlap
    const q = query.toLowerCase().split(/\W+/).filter(Boolean);
    let lex = 0;
    const text = (item.title + ' ' + item.text).toLowerCase();
    for(let w of q) if(text.includes(w)) lex += 1;
    // combined (weights tuned experimentally)
    const score = vscore * 0.8 + (lex / Math.max(1, q.length)) * 0.2;
    return {item, score, vscore, lex};
  });
  scored.sort((a,b)=>b.score - a.score);
  return scored.slice(0, topK);
}

/* ---------- Web search functions (DuckDuckGo + Wikipedia) ----------
   Try DuckDuckGo Instant Answer (JSONP-like API) and Wikipedia REST as fallback.
   Note: CORS may block some responses ‚Äî fall back to open search page.
*/
async function webSearchDuck(query){
  try{
    const url = 'https://api.duckduckgo.com/?q=' + encodeURIComponent(query) + '&format=json&no_html=1';
    const r = await fetch(url);
    if(!r.ok) throw new Error('DDG failed');
    const j = await r.json();
    const results = [];
    if(j.Abstract && j.Abstract.length) results.push({title:j.Heading||query, snippet:j.Abstract, url:j.AbstractURL||''});
    if(j.RelatedTopics && j.RelatedTopics.length){
      j.RelatedTopics.slice(0,4).forEach(t=>{
        if(t.Text) results.push({title:t.Text.split(' - ')[0], snippet:t.Text, url:t.FirstURL || ''});
      });
    }
    return results;
  }catch(e){
    console.warn('DuckDuckGo error', e);
    return null;
  }
}

async function webSearchWiki(query){
  try{
    const url = 'https://en.wikipedia.org/w/api.php?action=query&format=json&prop=extracts&exintro=true&explaintext=true&titles=' + encodeURIComponent(query) + '&origin=*';
    const r = await fetch(url);
    if(!r.ok) throw new Error('Wiki failed');
    const j = await r.json();
    const pages = j.query && j.query.pages;
    if(!pages) return null;
    const id = Object.keys(pages)[0];
    if(id === "-1") return null;
    const p = pages[id];
    return [{title:p.title, snippet:p.extract || '', url:'https://en.wikipedia.org/wiki/' + encodeURIComponent(p.title)}];
  }catch(e){
    console.warn('Wiki error', e);
    return null;
  }
}

/* ---------- Response pipeline ----------
   Modes:
   - local: only KB retrieval + composition
   - webonly: search web and synthesize result
   - hybrid: prefer KB, then web fallback and combine sources
*/
async function generateReply(userText){
  const mode = modeSelect.value;
  const webAllowed = webToggle.checked;
  // 1) local retrieval
  if(mode === 'local' || mode === 'hybrid'){
    const local = retrieveLocal(userText, 6);
    if(local && local.length && local[0].score > 0.17){ // heuristic threshold
      // compose a concise answer using top 3 items
      const top = local.slice(0,3);
      let text = 'R√©ponse bas√©e sur la base locale :\n';
      top.forEach((s,idx)=>{
        text += `\n${idx+1}) ${s.item.title} ‚Äî ${s.item.text.slice(0,240)}`;
      });
      return {text, sources: top.map(s => ({type:'kb', id:s.item.id}))};
    }
    if(mode === 'local') return {text:'Je n ai pas d information pertinente dans la base locale. Essaie la recherche web ou ajoute des √©l√©ments √† la KB.', sources:[]};
  }

  // 2) web search if allowed
  if((mode === 'hybrid' || mode === 'webonly') && webAllowed){
    // try duckduckgo
    const ddg = await webSearchDuck(userText);
    if(ddg && ddg.length){
      const text = ddg.slice(0,3).map(d => `${d.title} ‚Äî ${d.snippet}${d.url? ' ('+d.url+')':''}`).join('\n\n');
      return {text: 'R√©sultats web :\n\n' + text, sources: ddg.map(d => ({type:'web',title:d.title,url:d.url}))};
    }
    // fallback to wiki
    const wk = await webSearchWiki(userText);
    if(wk && wk.length){
      const text = wk.map(w => `${w.title} ‚Äî ${w.snippet}\n(${w.url})`).join('\n\n');
      return {text: 'R√©sultats Wikipedia :\n\n' + text, sources: wk.map(w=>({type:'web',title:w.title,url:w.url}))};
    }
    // if web failed
    return {text:'Aucune information web instantan√©e trouv√©e. Essaie une requ√™te plus pr√©cise.', sources:[]};
  }

  // final fallback
  return {text:'Je n ai pas assez d information. Essaie d activer la recherche web ou d enrichir la KB.', sources:[]};
}

/* ---------- UI rendering ---------- */
function renderChat(){
  chatEl.innerHTML = '';
  chat.forEach(m=>{
    const div = document.createElement('div'); div.className='bubble ' + (m.role === 'user' ? 'user' : 'ai');
    div.innerHTML = `<div>${m.text.split('\n').map(line => esc(line)).join('<br/>')}</div><div class="meta">${new Date(m.ts).toLocaleString()}</div>`;
    chatEl.appendChild(div);
  });
  chatEl.scrollTop = chatEl.scrollHeight;
  $('msgCount').textContent = 'Messages: ' + chat.length;
  updateChart();
}

function renderKB(){
  kbList.innerHTML = '';
  kb.forEach(k=>{
    const d = document.createElement('div'); d.className='kb-item';
    d.innerHTML = `<strong>${esc(k.title)}</strong><div class="small">${esc(k.text.slice(0,180))}${k.text.length>180?'...':''}</div>`;
    kbList.appendChild(d);
  });
  kbCount.textContent = kb.length;
}

/* ---------- Chat helpers ---------- */
function addChat(role, text){
  chat.push({role, text, ts: now()});
  localStorage.setItem(KEY_CHAT, JSON.stringify(chat));
  renderChat();
}

/* ---------- send flow ---------- */
sendBtn.addEventListener('click', async ()=>{
  const text = inputEl.value.trim(); if(!text) return;
  inputEl.value=''; addChat('user', text);
  addChat('ai', '‚Ä¶'); // placeholder
  try{
    const res = await generateReply(text);
    chat.pop(); // remove placeholder
    addChat('ai', res.text);
    // if voice enabled speak text (option)
    if(voiceToggle.checked) speakText(res.text);
  }catch(e){
    chat.pop();
    addChat('ai', 'Erreur interne: ' + (e.message || e));
  }
});
inputEl.addEventListener('keydown', e => { if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendBtn.click(); } });

/* ---------- web search UI ---------- */
webSearchBtn.addEventListener('click', async ()=>{
  const q = webQuery.value.trim(); if(!q) return;
  webResults.innerHTML = '<div class="small">Recherche en cours‚Ä¶</div>';
  let html = '';
  try{
    const ddg = await webSearchDuck(q);
    if(ddg && ddg.length){
      ddg.slice(0,5).forEach(d => { html += `<div style="margin-bottom:8px"><strong>${esc(d.title)}</strong><div class="small">${esc(d.snippet)}</div>${d.url?`<div class="small"><a href="${d.url}" target="_blank">‚Üí source</a></div>`:''}</div>`; });
      webResults.innerHTML = html;
      return;
    }
    const wk = await webSearchWiki(q);
    if(wk && wk.length){
      wk.forEach(w => { html += `<div style="margin-bottom:8px"><strong>${esc(w.title)}</strong><div class="small">${esc(w.snippet)}</div><div class="small"><a href="${w.url}" target="_blank">‚Üí source</a></div></div>`; });
      webResults.innerHTML = html;
      return;
    }
    webResults.innerHTML = '<div class="small">Aucun r√©sultat instantan√© ‚Äî ouvrez la recherche web.</div>';
  }catch(e){
    webResults.innerHTML = '<div class="small">Erreur recherche (CORS possible). <a href="https://duckduckgo.com/?q='+encodeURIComponent(q)+'" target="_blank">Ouvrir DuckDuckGo</a></div>';
  }
});

/* ---------- export / import KB & chat ---------- */
$('exportKbBtn').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(kb,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'luna_kb.json'; a.click(); URL.revokeObjectURL(url);
});
$('exportChatBtn').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(chat,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'luna_chat.json'; a.click(); URL.revokeObjectURL(url);
});
$('clearChatBtn').addEventListener('click', ()=>{
  if(confirm('Effacer l historique local ?')){ chat = []; localStorage.removeItem(KEY_CHAT); renderChat(); }
});

/* ---------- add KB ---------- */
addKbBtn.addEventListener('click', ()=>{
  const t = kbTitle.value.trim() || ('Note ' + (kb.length+1));
  const text = kbText.value.trim();
  if(!text){ toast('Texte KB vide'); return; }
  const item = {id:'kb_'+Math.random().toString(36).slice(2,9), title:t, text, embedding: null, created: now()};
  item.embedding = nnEmbed(item.title + ' ' + item.text);
  kb.unshift(item);
  localStorage.setItem(KEY_KB, JSON.stringify(kb));
  kbTitle.value=''; kbText.value=''; renderKB();
});

/* ---------- reset to defaults ---------- */
resetAllBtn.addEventListener('click', ()=>{
  if(!confirm('R√©initialiser la KB par d√©faut et effacer historique (local) ?')) return;
  localStorage.removeItem(KEY_KB); localStorage.removeItem(KEY_CHAT); localStorage.removeItem(KEY_NN);
  kb = null; chat = []; nn = null;
  ensureKB(); chat = []; localStorage.setItem(KEY_CHAT, JSON.stringify(chat)); renderChat();
});

/* ---------- voice (optional) & mic (speech-to-text) ---------- */
function speakText(text){
  try{
    const ut = new SpeechSynthesisUtterance(text);
    ut.lang = navigator.language || 'fr-FR';
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(ut);
  }catch(e){ console.warn('TTS error', e); }
}

let recognition = null, recognizing = false;
function initSpeech(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){ micBtn.disabled = true; micBtn.title = 'Reconnaissance vocale non support√©e'; return; }
  recognition = new SR();
  recognition.lang = navigator.language || 'fr-FR';
  recognition.interimResults = false;
  recognition.onresult = ev => {
    const text = ev.results[0][0].transcript;
    inputEl.value = text;
    sendBtn.click();
  };
  recognition.onend = ()=> { recognizing = false; micBtn.textContent='üé§'; };
  recognition.onerror = e => { recognizing = false; micBtn.textContent='üé§'; console.error(e); toast('Erreur reconnaissance vocale'); };
}
initSpeech();
micBtn.addEventListener('click', ()=>{
  if(!recognition) return;
  if(!recognizing){ recognition.start(); recognizing=true; micBtn.textContent='‚è∫Ô∏è'; } else { recognition.stop(); recognizing=false; micBtn.textContent='üé§'; }
});

/* ---------- Chart: activity ---------- */
let chart = null;
function updateChart(){
  const perHour = {};
  chat.forEach(m => {
    const h = new Date(m.ts).toISOString().slice(0,13);
    perHour[h] = (perHour[h]||0) + 1;
  });
  const labels = Object.keys(perHour).slice(-20);
  const data = labels.map(l => perHour[l] || 0);
  if(!chart){
    chart = new Chart(activityChartCtx, {
      type:'line',
      data:{ labels, datasets:[{ label:'Messages', data, borderColor:'#7c3aed', backgroundColor:'rgba(124,58,237,0.15)', tension:0.35 }] },
      options:{ plugins:{legend:{display:false}}, scales:{ x:{ display:false } } }
    });
  } else {
    chart.data.labels = labels; chart.data.datasets[0].data = data; chart.update();
  }
}

/* ---------- render KB list ---------- */
function renderKB_initial(){ kbList.innerHTML=''; kb.forEach(k => { const d=document.createElement('div'); d.className='kb-item'; d.innerHTML = `<strong>${esc(k.title)}</strong><div class="small">${esc(k.text.slice(0,180))}${k.text.length>180?'...':''}</div>`; kbList.appendChild(d); }); kbCount.textContent = kb.length; }

/* ---------- boot: load or create KB & render UI ---------- */
function boot(){
  // load saved states
  try{ kb = JSON.parse(localStorage.getItem(KEY_KB)); } catch(e){ kb = null; }
  try{ nn = JSON.parse(localStorage.getItem(KEY_NN)); } catch(e){ nn = null; }
  if(!kb){ // initialize huge KB
    kb = defaultKB().map(it => ({...it, embedding: null}));
    localStorage.setItem(KEY_KB, JSON.stringify(kb));
  }
  if(!nn) initNN();
  // compute any missing embeddings in background
  let i=0;
  function computeStep(){
    const chunk = 10;
    for(let k=0;k<chunk && i<kb.length;k++,i++){
      if(!kb[i].embedding) kb[i].embedding = nnEmbed(kb[i].title + ' ' + kb[i].text);
    }
    localStorage.setItem(KEY_KB, JSON.stringify(kb));
    if(i < kb.length) setTimeout(computeStep, 30);
    else { renderKB_initial(); }
  }
  computeStep();
  renderChat();
  updateChart();
}
boot();

/* ---------- retrieval UI example: quick command "find" ---------- */
function quickFind(query){
  const res = retrieveLocal(query, 5);
  if(res && res.length){
    const text = 'R√©sultats (KB):\n' + res.map(r => `${r.item.title} ‚Äî ${r.item.text}`).join('\n\n');
    addChat('ai', text);
  } else {
    addChat('ai', "Aucun r√©sultat local. Essayez la recherche web.");
  }
}

/* ---------- helper alias for addChat used in some places ---------- */
function addChat(role, text){ chat.push({role, text, ts: now()}); localStorage.setItem(KEY_CHAT, JSON.stringify(chat)); renderChat(); }

/* ---------- initial greeting ---------- */
if(chat.length === 0){
  addChat('ai', "üëã Salut ‚Äî je suis Luna Pro (mode local). Pose-moi une question ou active la recherche web. Je utilise une large base de connaissances locale et un moteur de recherche int√©gr√©.");
}

/* ---------- end of file ---------- */

</script>
</body>
</html>
